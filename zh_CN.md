# OpenWrt 配置 ipip6 教程（适用于 NTT + v6plus + 固定 IPv4）

[🇺🇸 English](./README.md) | [🇨🇳 中文](./zh_CN.md) | [🇯🇵 日本語](./ja_JP.md)

---

本仓库提供一份面向在日本使用 NTT 系运营商（`v6plus` + **固定 IPv4**）的用户，在 OpenWrt 路由器上手动配置 `ipip6` 隧道的教程。

本教程基于以下前提：

- 使用 DHCPv6 的 Prefix Delegation（PD）
- ISP 分配 `/56` 前缀（如果是 `/64`，则行为未知）
- 使用 ISP 提供的 BR 地址、固定 IPv4 和接口 ID 进行验证

📌 本教程旨在帮助你通过 OpenWrt 成功建立 IPv4 over IPv6 的通信。

---

## 配置步骤

### 1. 安装 ipip6 支持包

使用以下仓库安装：

> https://github.com/HiraokaHyperTools/openwrt-ipip6

安装完成以后**重启路由器**。

---

### 2. 配置 `wan6` 接口（DHCPv6 客户端）

- 添加一个 `wan6` 接口
- 设置为 `DHCPv6` 客户端
- 绑定硬件与防火墙 zone
- 应用后应该可以获取到一个 `/56` 的 IPv6 前缀（后续使用）

---

### 3. 添加 ipip6 接口

- 协议类型选择：`IPv4 over IPv6 (ipip6)`  
  此协议由上面提到的包提供，根据说明已合并进入 OpenWrt 主线 23.05，可通过`opkg`安装

#### 3.1 协议设置

- `Remote IPv6 address`：填写 BR アドレス（例如：`2404:9200:225:100::65`）
- `Local IPv4 address`：ISP 分配的 IPv4 地址
- `Local IPv6 address`：`[获取到的前缀]:[インターフェースID]`

示例：

- 获取到的 DHCPv6 前缀为：`240b:114:514:8100::/56`
- ISP 提供的インターフェースID 为：`1919:0810:0893:0000`
- 则填写为：`240b:114:514:8100:1919:0810:0893:0000`

#### 3.2 高级设置

- 隧道绑定接口：选择 `wan6`
- Encapsulation limit：设为 `ignore`
- 分配长度：64
- IPv6 后缀：填写 ISP 提供的 ID，例如 `::1919:0810:0893:0000`
- IPv6 preference：设为 `0`
- MTU：默认 `1280`，最大 `1460`，可以适当调整

#### 3.3 防火墙设置

- 分配对应防火墙 zone
- 禁用 DHCPv6 路由通告与服务

---

### 4. 配置 LAN 接口

- IPv6 分配长度设为 `/64`
- IPv6 分配提示：设为 `1` 或 `10`
- IPv6 模式均设置为“服务器模式”

---

### 5. 确认状态

#### 5.1 ipip6 接口地址验证

应用设置后，`ipip6` 接口应显示与 `wan6` 相同前缀、后缀为 `1` 的地址：

- 例如：`240b:114:514:8100::1/64`（注意此为显示，实际应为验证组合地址）
- 可通过 SSH 使用 `ip` 命令查看实际接口地址：

  ```
  link/tunnel6 240b:114:514:8100:1919:0810:0893:0000 peer 2404:9200:225:100::65
  ```

#### 5.2 lan 接口地址验证

根据分配提示：

- 提示为 `1`：`240b:114:514:8101::1/64`
- 提示为 `10`：`240b:114:514:8110::1/64`

---

### 6. 隧道连通性测试

若在 `ipip6` 接口上能观察到双向流量，则说明隧道建立成功。

可使用测试网站确认 IPv4 / IPv6 连通性。

---

## 总结

**必须确保 `ipip6` 接口获取的 IPv6 地址使用了 DHCPv6 获取的同一前缀，否则组合地址验证将失败。**

默认设置下：

- `lan` 会获得 `8100::/64`
- `wan` 会变成 `8101::/64`

这样组合出来的验证地址与实际需要的不一致，无法通过认证。

解决方法：

- 通过指定 `lan` 的分配提示
- 并设置 `ipip6` 的地址优先级

确保 `ipip6` 获取正确组合的地址，即可成功建立隧道。
